# Dockerizing CLIPER

This document outlines the steps and considerations for deploying the CLIPER tool using Docker. Docker allows you to package CLIPER and its dependencies into a portable container, ensuring consistent execution across different environments.

## 1. Prerequisites

Before you begin, ensure you have the following installed on your system:

-   **Docker**: [Install Docker Engine](https://docs.docker.com/engine/install/)
-   **Docker Compose**: [Install Docker Compose](https://docs.docker.com/compose/install/) (usually comes with Docker Desktop)

## 2. Dockerfile

The `Dockerfile` defines the environment for your CLIPER application. It will include Python, system dependencies like FFmpeg, and your project's Python dependencies.

Create a file named `Dockerfile` in the root of your CLIPER project:

```dockerfile
# Use an official Python runtime as a parent image
FROM python:3.10-slim-buster

# Set the working directory in the container
WORKDIR /app

# Install system dependencies required by FFmpeg and WhisperX
# FFmpeg is crucial for video processing
# libmagic1 is needed by some Python packages (e.g., python-magic)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    ffmpeg \
    libmagic1 && \
    rm -rf /var/lib/apt/lists/*

# Copy pyproject.toml and uv.lock first to leverage Docker cache
# uv.lock ensures reproducible builds
COPY pyproject.toml uv.lock ./

# Install Python dependencies using uv
# uv is recommended for its speed and lock file management
RUN pip install uv && \
    uv sync --system

# Copy the rest of your application code
COPY . .

# Expose any ports if your application had a web interface (not applicable for CLI)
# EXPOSE 8000

# Define the command to run your application
# This will be the default command when the container starts
CMD ["uv", "run", "cliper.py"]
```

## 3. Docker Compose Configuration

`docker-compose.yml` allows you to define and run multi-container Docker applications. For CLIPER, it will manage the application container, volume mounts, and environment variables.

Create a file named `docker-compose.yml` in the root of your CLIPER project:

```yaml
version: '3.8'

services:
  cliper:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cliper_app
    environment:
      # Mount your Google Gemini API Key from your host environment
      # IMPORTANT: Replace 'your_gemini_api_key_here' with your actual key
      # or better, set it in your host's .env file and reference it here:
      # - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      GOOGLE_API_KEY: "your_gemini_api_key_here"
      # Optional: Configure Whisper model size
      WHISPER_MODEL: "base"
      # Optional: Set log level for debugging
      LOG_LEVEL: "INFO"
    volumes:
      # Mount the current project directory into the container
      # This allows CLIPER to access your input videos and save outputs
      - .:/app
      # Mount a dedicated volume for WhisperX models to persist them
      # This prevents re-downloading models every time the container starts
      - cliper_whisper_models:/root/.cache/whisperx
    # If you need GPU support for WhisperX (highly recommended for performance)
    # uncomment the following lines and ensure your Docker setup supports NVIDIA GPUs
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    # stdin_open: true # Keep stdin open for interactive CLI
    # tty: true        # Allocate a pseudo-TTY for interactive CLI

volumes:
  cliper_whisper_models:
    driver: local
```

## 4. Building and Running the Docker Container

### 4.1 Build the Docker Image

Navigate to the root of your CLIPER project in your terminal and build the Docker image:

```bash
docker-compose build
```

This command will read your `Dockerfile` and `docker-compose.yml` to create the `cliper` image. This might take some time as it installs FFmpeg and Python dependencies.

### 4.2 Run CLIPER

Once the image is built, you can run CLIPER using Docker Compose:

```bash
docker-compose run cliper
```

This command will start the `cliper` service, execute the `CMD` defined in your `Dockerfile` (which is `uv run cliper.py`), and allow you to interact with the CLIPER CLI.

**Important Notes:**

-   **API Key**: Ensure your `GOOGLE_API_KEY` is correctly set in `docker-compose.yml` or via an `.env` file on your host.
-   **Volumes**: The `.:/app` volume mount means that any changes you make to your local project files will be reflected inside the container, and any output generated by CLIPER (e.g., in `output/`, `downloads/`, `temp/`) will appear in your local project directory.
-   **WhisperX Models**: The `cliper_whisper_models` volume ensures that WhisperX models are downloaded only once and persist across container restarts, saving time and bandwidth.
-   **Interactive CLI**: The `stdin_open: true` and `tty: true` (if uncommented) are important for interactive CLI applications like CLIPER, allowing you to provide input.

### 4.3 Running Specific Commands

You can also run specific commands within the container:

```bash
docker-compose run cliper uv run cliper.py --help
```

Or to run a specific CLIPER command:

```bash
docker-compose run cliper uv run cliper.py --download <youtube_url>
```

## 5. GPU Support (Optional, but Recommended for WhisperX)

WhisperX can be significantly faster when utilizing a GPU. To enable GPU support:

1.  **Install NVIDIA Container Toolkit**: Follow the instructions for your operating system: [NVIDIA Container Toolkit Installation Guide](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html)
2.  **Uncomment GPU lines in `docker-compose.yml`**:
    ```yaml
        deploy:
          resources:
            reservations:
              devices:
                - driver: nvidia
                  count: all
                  capabilities: [gpu]
    ```
3.  **Rebuild the image**: `docker-compose build` (Docker will now build with NVIDIA support).
4.  **Run**: `docker-compose run cliper`

## 6. Considerations

-   **Image Size**: The Docker image might be large due to FFmpeg and Python dependencies. Consider using multi-stage builds for production environments to reduce the final image size.
-   **Security**: Be mindful of sensitive information like API keys. Using environment variables (especially from a host `.env` file) is generally better than hardcoding them in `docker-compose.yml`.
-   **Performance**: For optimal performance, especially with WhisperX, ensure you have sufficient CPU/RAM allocated to Docker, and consider enabling GPU support if available.
-   **Updates**: To update CLIPER or its dependencies, you'll need to pull the latest code, update `uv.lock` (if dependencies changed), and rebuild the Docker image (`docker-compose build`).

This setup provides a robust and reproducible environment for running CLIPER.
