# Sesión 2025-11-28: Testing ffmpegcv & Pivot a FFmpeg Subprocess

## Resumen Ejecutivo

**Objetivo de hoy:** Resolver issue de OpenCV VideoWriter en macOS M4 usando ffmpegcv.

**Resultado:** ffmpegcv NO funciona en macOS M4 (BrokenPipeError). Pivoteamos a Opción D (FFmpeg Subprocess).

---

## Trabajo Realizado

### 1. Investigación Inicial (Completada)

**Contexto:** OpenCV VideoWriter falla en macOS M4 porque opencv-python (pip) instala FFmpeg amd64 en lugar de arm64.

**Evidencia:**
- Web research: Issue conocido en Stack Overflow, OpenCV Forums, Roboflow
- Afecta todos los Macs Apple Silicon (M1/M2/M4)
- NO es problema específico de hardware M4

**Opciones evaluadas:**
- A: ffmpegcv (drop-in replacement)
- B: conda-forge opencv (rompe filosofía uv)
- C: Build from source (no reproducible)
- D: FFmpeg subprocess directo (arquitectónicamente correcto)

**Decisión:** Intentar A primero (quick validation), si falla → D

---

### 2. Implementación ffmpegcv (Fallida)

**Cambios realizados:**

1. **Dependencia instalada:**
   ```bash
   uv add ffmpegcv  # v0.3.18
   ```

2. **Código modificado (src/reframer.py):**
   ```python
   import ffmpegcv

   # INTENTO 1: Con fourcc (FALLÓ)
   fourcc = cv2.VideoWriter_fourcc(*'mp4v')
   out = ffmpegcv.VideoWriter(path, fourcc, fps, size)
   # Error: "Codec should be a string, not fourcc"

   # INTENTO 2: Con string directo (FALLÓ)
   out = ffmpegcv.VideoWriter(path, 'libx264', fps, size)
   # Error: BrokenPipeError [Errno 32]
   ```

3. **Testing exhaustivo:**
   - Test end-to-end con FaceReframer: BrokenPipeError
   - Test minimal (10 líneas): BrokenPipeError
   - Codecs probados: libx264, h264_videotoolbox, mpeg4
   - Resultado: TODOS fallan con mismo error

**Archivos de test creados:**
- `tests/test_ffmpegcv_integration.py`
- `tests/test_ffmpegcv_minimal.py`
- `tests/test_ffmpegcv_debug.py`

---

### 3. Diagnóstico del Error

**Error:** `BrokenPipeError: [Errno 32] Broken pipe`

**Ubicación:** `ffmpegcv/ffmpeg_writer.py:97` en `self.process.stdin.write(img)`

**Causa raíz:**
- `VideoWriter.isOpened()` retorna `True` (subprocess creado)
- `write()` falla inmediatamente al escribir primer frame
- Subprocess FFmpeg se cierra antes de recibir datos
- Bug en librería ffmpegcv, NO en nuestro código

**Evidencia de bug:**
```python
# Código minimal que falla:
writer = ffmpegcv.VideoWriter("test.mp4", "libx264", 30.0, (1080, 1920))
assert writer.isOpened() == True  # ✓ Pasa
frame = np.zeros((1920, 1080, 3), dtype=np.uint8)
writer.write(frame)  # ✗ BrokenPipeError
```

---

## Decisiones Arquitectónicas

### DECISIÓN: Descartar ffmpegcv, Implementar FFmpeg Subprocess

**PROBLEMA:**
```
ffmpegcv tiene bug no resoluble en macOS Apple Silicon.
Broken pipe persiste en todos los codecs probados.
Bug está en librería externa, no podemos fixear sin modificarla.
```

**ALTERNATIVAS:**
1. Reportar bug a ffmpegcv y esperar fix (semanas/meses)
2. Investigar más profundamente ffmpegcv (ya hicimos testing exhaustivo)
3. Implementar FFmpeg subprocess directo (Opción D)

**TRADE-OFFS:**

Opción D (FFmpeg Subprocess):
```
+ Control total sobre parámetros FFmpeg
+ Error handling granular (stderr monitoring)
+ Coherente con arquitectura CLIPER (ya usamos FFmpeg)
+ Sin dependencias externas problemáticas
+ Robustez: reintentos, validación, logging detallado

- 2-3 horas implementación (vs 10 min ffmpegcv teórico)
- Manejo manual de pipes (complejidad justificada)
- Debugging más verboso (pero más control)
```

**RESULTADO:**
```
Opción D es la arquitectónicamente correcta para CLIPER:
1. video_exporter.py ya usa FFmpeg subprocess (patrón establecido)
2. Filosofía "Local-First" compatible
3. Control total = robustez > simplicidad
4. Trade-off tiempo aceptable (2-3h) vs dependencias frágiles
```

---

## Estado Actual del Código

### Archivos Modificados (NO FUNCIONALES)

**src/reframer.py:**
- ✓ MediaPipe face detection implementado
- ✓ Frame sampling (cada 3 frames)
- ✓ Scale-first architecture
- ✓ Dynamic crop calculation
- ✗ VideoWriter usa ffmpegcv (NO FUNCIONA)
- → PRÓXIMO: Reemplazar con FFmpeg subprocess

**pyproject.toml:**
- ffmpegcv==0.3.18 agregado (remover después de Opción D)

**Dockerfile:**
- OpenCV dependencies agregadas (libgl1-mesa-glx, libglib2.0-0)

### Face Tracking: 100% Implementado (Excepto VideoWriter)

**Componentes funcionando:**
- MediaPipe face detection (validado en spike)
- Frame sampling cada 3 frames (performance óptimo)
- Scale-first para aspect ratio 16:9 → 9:16
- Dynamic crop calculation con "keep_in_frame" strategy
- Safe zone margin y smoothing logic

**Solo falta:** Escribir frames procesados a archivo (VideoWriter)

---

## Próximos Pasos (Mañana)

### Paso 1: Implementar FFmpeg Subprocess VideoWriter

**Objetivo:** Crear clase `FFmpegVideoWriter` en `src/reframer.py`

**Componentes:**

1. **Command Builder:**
   ```python
   def _build_ffmpeg_command(self, output_path, width, height, fps, codec='libx264'):
       return [
           'ffmpeg',
           '-y',  # Overwrite
           '-f', 'rawvideo',
           '-vcodec', 'rawvideo',
           '-pix_fmt', 'bgr24',
           '-s', f'{width}x{height}',
           '-r', str(fps),
           '-i', '-',  # stdin
           '-c:v', codec,
           '-preset', 'medium',
           '-crf', '23',
           str(output_path)
       ]
   ```

2. **Pipe Writer:**
   ```python
   def write(self, frame):
       try:
           self.process.stdin.write(frame.tobytes())
           return True
       except BrokenPipeError:
           # Leer stderr para diagnosticar
           return False
   ```

3. **Error Handler:**
   ```python
   def _monitor_stderr(self):
       # Non-blocking read de stderr
       # Log warnings/errors de FFmpeg
   ```

4. **Cleanup:**
   ```python
   def release(self):
       if self.process:
           self.process.stdin.close()
           self.process.wait()
   ```

**Referencia:** Ver `src/video_exporter.py` para patrón establecido de FFmpeg subprocess.

---

### Paso 2: Testing End-to-End

**Script de test:**
```bash
# Limpiar outputs previos
rm -rf output/*LZlXASa8CZM*

# Correr CLI completo
uv run python cliper.py
# URL: https://www.youtube.com/watch?v=LZlXASa8CZM
# Aspect ratio: 9:16
# Face tracking: Yes
# Strategy: keep_in_frame
```

**Validación esperada:**
- VideoWriter funciona con FFmpeg subprocess
- Face tracking operativo (rostro en frame)
- Clips exportados a output/ con dynamic reframing
- Sin errors en logs

---

### Paso 3: Optimización (PASO 07)

**Solo si Paso 1 y 2 exitosos:**

1. **Smoothing:** Moving average para crop positions
2. **Predictive reframing:** 2-second lookahead
3. **Performance tuning:** Ajustar frame_sample_rate si necesario

---

## Archivos de Documentación Actualizados

1. **pasoxpaso/todoPASO3/03-reframer-module.md**
   - Issue 3: Solución ffmpegcv agregada
   - Resultados de testing documentados
   - Decisión de pivot a Opción D justificada

2. **Este archivo (SESSION-2025-11-28.md)**
   - Resumen ejecutivo de sesión
   - Estado actual y próximos pasos

---

## Lecciones Aprendidas

### Arquitectura > Quick Fixes

**Aprendizaje:**
```
ffmpegcv parecía "drop-in replacement" perfecto (10 min vs 2-3h).
En realidad: Bug no resoluble, tiempo perdido en debugging.
Opción D (FFmpeg subprocess) hubiera sido más rápida desde inicio.
```

**Aplicación futura:**
- Evaluar madurez de librerías antes de integrar
- Preferir soluciones arquitectónicamente coherentes con proyecto existente
- Quick validation útil, pero no a costa de introducir dependencias frágiles

### Testing Estratégico

**Lo que funcionó:**
- Test minimal para aislar bug (10 líneas reprodujeron issue)
- Web research antes de implementar (identificó issue macOS M4)
- Documentación exhaustiva de intentos (este archivo)

**Para próxima sesión:**
- Comenzar con Opción D directamente (patrón ya establecido en CLIPER)
- Validar con video real inmediatamente después de implementar
- No perder tiempo en debugging de bugs de librerías externas

---

## Tiempo Invertido

- Investigación web: 20 min
- Instalación ffmpegcv: 5 min
- Implementación intento 1 (fourcc): 15 min
- Implementación intento 2 (string codecs): 10 min
- Testing y debugging: 30 min
- Documentación: 20 min

**Total:** ~100 min

**Siguiente sesión estimada:** 2-3 horas (Opción D completa + testing)

---

## Comandos Útiles para Mañana

```bash
# Verificar FFmpeg disponible
ffmpeg -version
ffmpeg -codecs | grep h264

# Limpiar archivos de test
rm -f tests/test_*.mp4

# Remover ffmpegcv (después de implementar Opción D)
uv remove ffmpegcv

# Testing completo
uv run python tests/test_ffmpeg_subprocess.py  # Crear mañana
```

---

**Estado:** Face tracking 95% completo. Solo falta VideoWriter funcional.

**Confianza Opción D:** Alta. CLIPER ya usa FFmpeg subprocess exitosamente en video_exporter.py.

**Próxima sesión:** Implementar FFmpegVideoWriter y cerrar PASO 3.
